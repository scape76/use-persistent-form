<pre class="shiki rose-pine" style="background-color:#191724;color:#e0def4" tabindex="0"><code><span class="line"><span style="color:#31748F">import </span><span style="color:#908CAA">{</span><span style="color:#E0DEF4;font-style:italic"> useCallback</span><span style="color:#908CAA">,</span><span style="color:#E0DEF4;font-style:italic"> useEffect</span><span style="color:#908CAA"> }</span><span style="color:#31748F"> from </span><span style="color:#F6C177">"react"</span><span style="color:#908CAA">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">import </span><span style="color:#908CAA">{</span></span>
<span class="line"><span style="color:#E0DEF4;font-style:italic">  useForm</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#E0DEF4;font-style:italic">  useWatch</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#31748F">  type </span><span style="color:#E0DEF4;font-style:italic">UseFormProps</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#31748F">  type </span><span style="color:#E0DEF4;font-style:italic">FieldValues</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#31748F">  type </span><span style="color:#E0DEF4;font-style:italic">UseFormReturn</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#31748F">  type </span><span style="color:#E0DEF4;font-style:italic">DefaultValues</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#908CAA">}</span><span style="color:#31748F"> from </span><span style="color:#F6C177">"react-hook-form"</span><span style="color:#908CAA">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">type</span><span style="color:#9CCFD8"> StorageKey</span><span style="color:#31748F"> =</span><span style="color:#9CCFD8"> string</span><span style="color:#31748F"> |</span><span style="color:#9CCFD8"> Array</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">string</span><span style="color:#908CAA">>;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">type</span><span style="color:#9CCFD8"> AsyncDefaultValues</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">TFieldValues</span><span style="color:#908CAA">></span><span style="color:#31748F"> =</span><span style="color:#E0DEF4"> (</span></span>
<span class="line"><span style="color:#C4A7E7;font-style:italic">  payload</span><span style="color:#31748F">?:</span><span style="color:#9CCFD8"> unknown</span></span>
<span class="line"><span style="color:#E0DEF4">) </span><span style="color:#31748F">=></span><span style="color:#9CCFD8"> Promise</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">TFieldValues</span><span style="color:#908CAA">>;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">type</span><span style="color:#9CCFD8"> FormDefaultValues</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">TFieldValues</span><span style="color:#31748F"> extends</span><span style="color:#9CCFD8"> FieldValues</span><span style="color:#31748F"> =</span><span style="color:#9CCFD8"> FieldValues</span><span style="color:#908CAA">></span><span style="color:#31748F"> =</span></span>
<span class="line"><span style="color:#31748F">  |</span><span style="color:#9CCFD8"> DefaultValues</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">TFieldValues</span><span style="color:#908CAA">></span></span>
<span class="line"><span style="color:#31748F">  |</span><span style="color:#9CCFD8"> AsyncDefaultValues</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">TFieldValues</span><span style="color:#908CAA">>;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">type</span><span style="color:#9CCFD8"> UsePersistentFormProps</span><span style="color:#908CAA">&#x3C;</span></span>
<span class="line"><span style="color:#9CCFD8">  TFieldValues</span><span style="color:#31748F"> extends</span><span style="color:#9CCFD8"> FieldValues</span><span style="color:#31748F"> =</span><span style="color:#9CCFD8"> FieldValues</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#9CCFD8">  TContext</span><span style="color:#31748F"> =</span><span style="color:#9CCFD8"> any</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#908CAA">></span><span style="color:#31748F"> =</span><span style="color:#9CCFD8"> UseFormProps</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">TFieldValues</span><span style="color:#908CAA">,</span><span style="color:#9CCFD8"> TContext</span><span style="color:#908CAA">></span><span style="color:#31748F"> &#x26;</span><span style="color:#908CAA"> {</span></span>
<span class="line"><span style="color:#EBBCBA;font-style:italic">  storageKey</span><span style="color:#31748F">:</span><span style="color:#9CCFD8"> StorageKey</span><span style="color:#908CAA">;</span></span>
<span class="line"><span style="color:#EBBCBA;font-style:italic">  skipStorageValidation</span><span style="color:#31748F">?:</span><span style="color:#9CCFD8"> boolean</span><span style="color:#908CAA">;</span></span>
<span class="line"><span style="color:#EBBCBA;font-style:italic">  storage</span><span style="color:#31748F">?:</span><span style="color:#9CCFD8"> Storage</span><span style="color:#908CAA">;</span></span>
<span class="line"><span style="color:#908CAA">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">type</span><span style="color:#9CCFD8"> UsePersistentFormReturn</span><span style="color:#908CAA">&#x3C;</span></span>
<span class="line"><span style="color:#9CCFD8">  TFieldValues</span><span style="color:#31748F"> extends</span><span style="color:#9CCFD8"> FieldValues</span><span style="color:#31748F"> =</span><span style="color:#9CCFD8"> FieldValues</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#9CCFD8">  TContext</span><span style="color:#31748F"> =</span><span style="color:#9CCFD8"> any</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#9CCFD8">  TransformedValues</span><span style="color:#31748F"> extends</span><span style="color:#9CCFD8"> FieldValues</span><span style="color:#31748F"> |</span><span style="color:#9CCFD8"> undefined</span><span style="color:#31748F"> =</span><span style="color:#9CCFD8"> undefined</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#908CAA">></span><span style="color:#31748F"> =</span><span style="color:#9CCFD8"> UseFormReturn</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">TFieldValues</span><span style="color:#908CAA">,</span><span style="color:#9CCFD8"> TContext</span><span style="color:#908CAA">,</span><span style="color:#9CCFD8"> TransformedValues</span><span style="color:#908CAA">></span><span style="color:#31748F"> &#x26;</span><span style="color:#908CAA"> {</span></span>
<span class="line"><span style="color:#EBBCBA">  clearData</span><span style="color:#31748F">:</span><span style="color:#908CAA"> ()</span><span style="color:#31748F"> =></span><span style="color:#9CCFD8"> void</span><span style="color:#908CAA">;</span></span>
<span class="line"><span style="color:#908CAA">};</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">function</span><span style="color:#EBBCBA"> storageKeyToString</span><span style="color:#908CAA">(</span><span style="color:#C4A7E7;font-style:italic">storageKey</span><span style="color:#31748F">:</span><span style="color:#9CCFD8"> StorageKey</span><span style="color:#908CAA">)</span><span style="color:#31748F">:</span><span style="color:#9CCFD8"> string</span><span style="color:#908CAA"> {</span></span>
<span class="line"><span style="color:#31748F">  if</span><span style="color:#E0DEF4"> (</span><span style="color:#E0DEF4;font-style:italic">Array</span><span style="color:#31748F">.</span><span style="color:#EBBCBA">isArray</span><span style="color:#E0DEF4">(</span><span style="color:#E0DEF4;font-style:italic">storageKey</span><span style="color:#E0DEF4">)) </span><span style="color:#31748F">return</span><span style="color:#E0DEF4;font-style:italic"> storageKey</span><span style="color:#31748F">.</span><span style="color:#EBBCBA">join</span><span style="color:#E0DEF4">()</span><span style="color:#908CAA">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">  return</span><span style="color:#E0DEF4;font-style:italic"> storageKey</span><span style="color:#908CAA">;</span></span>
<span class="line"><span style="color:#908CAA">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">function</span><span style="color:#EBBCBA"> getFormDefaultValues</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">TFieldValues</span><span style="color:#31748F"> extends</span><span style="color:#9CCFD8"> FieldValues</span><span style="color:#31748F"> =</span><span style="color:#9CCFD8"> FieldValues</span><span style="color:#908CAA">>(</span></span>
<span class="line"><span style="color:#C4A7E7;font-style:italic">  key</span><span style="color:#31748F">:</span><span style="color:#9CCFD8"> string</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#C4A7E7;font-style:italic">  storage</span><span style="color:#31748F">:</span><span style="color:#9CCFD8"> Storage</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#C4A7E7;font-style:italic">  initValues</span><span style="color:#31748F">?:</span><span style="color:#9CCFD8"> FormDefaultValues</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">TFieldValues</span><span style="color:#908CAA">></span></span>
<span class="line"><span style="color:#908CAA">)</span><span style="color:#31748F">:</span><span style="color:#9CCFD8"> FormDefaultValues</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">TFieldValues</span><span style="color:#908CAA">></span><span style="color:#31748F"> |</span><span style="color:#9CCFD8"> undefined</span><span style="color:#908CAA"> {</span></span>
<span class="line"><span style="color:#31748F">  const</span><span style="color:#E0DEF4;font-style:italic"> values</span><span style="color:#31748F"> =</span><span style="color:#E0DEF4;font-style:italic"> storage</span><span style="color:#31748F">.</span><span style="color:#EBBCBA">getItem</span><span style="color:#E0DEF4">(</span><span style="color:#E0DEF4;font-style:italic">key</span><span style="color:#E0DEF4">)</span><span style="color:#908CAA">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">  if</span><span style="color:#E0DEF4"> (</span><span style="color:#31748F">!</span><span style="color:#E0DEF4;font-style:italic">values</span><span style="color:#E0DEF4">) </span><span style="color:#908CAA">{</span></span>
<span class="line"><span style="color:#31748F">    return</span><span style="color:#EBBCBA"> undefined</span><span style="color:#908CAA">;</span></span>
<span class="line"><span style="color:#908CAA">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">  const</span><span style="color:#E0DEF4;font-style:italic"> parsed</span><span style="color:#31748F"> =</span><span style="color:#E0DEF4;font-style:italic"> JSON</span><span style="color:#31748F">.</span><span style="color:#EBBCBA">parse</span><span style="color:#E0DEF4">(</span><span style="color:#E0DEF4;font-style:italic">values</span><span style="color:#E0DEF4">)</span><span style="color:#908CAA">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#908CAA;font-style:italic">  //</span><span style="color:#6E6A86;font-style:italic"> I think how can I parse the values from storage by schema</span></span>
<span class="line"><span style="color:#908CAA;font-style:italic">  //</span><span style="color:#6E6A86;font-style:italic"> currently, if schema is provided, it's provided via resolver</span></span>
<span class="line"><span style="color:#908CAA;font-style:italic">  //</span><span style="color:#6E6A86;font-style:italic"> but through resolver, there is no way to get it.</span></span>
<span class="line"><span style="color:#908CAA;font-style:italic">  //</span><span style="color:#6E6A86;font-style:italic"> passing schema as another prop feels kind of redundant?</span></span>
<span class="line"><span style="color:#31748F">  if</span><span style="color:#E0DEF4"> (</span><span style="color:#31748F">typeof</span><span style="color:#E0DEF4;font-style:italic"> parsed</span><span style="color:#31748F"> ===</span><span style="color:#F6C177"> "object"</span><span style="color:#31748F"> &#x26;&#x26;</span><span style="color:#31748F"> !</span><span style="color:#E0DEF4;font-style:italic">Array</span><span style="color:#31748F">.</span><span style="color:#EBBCBA">isArray</span><span style="color:#E0DEF4">(</span><span style="color:#E0DEF4;font-style:italic">parsed</span><span style="color:#E0DEF4">) </span><span style="color:#31748F">&#x26;&#x26;</span><span style="color:#E0DEF4;font-style:italic"> parsed</span><span style="color:#31748F"> !=</span><span style="color:#EBBCBA"> null</span><span style="color:#E0DEF4">) </span><span style="color:#908CAA">{</span></span>
<span class="line"><span style="color:#31748F">    return</span><span style="color:#908CAA"> {</span></span>
<span class="line"><span style="color:#31748F">      ...</span><span style="color:#E0DEF4;font-style:italic">initValues</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#31748F">      ...</span><span style="color:#E0DEF4;font-style:italic">parsed</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#908CAA">    };</span></span>
<span class="line"><span style="color:#908CAA">  }</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">  return</span><span style="color:#EBBCBA"> undefined</span><span style="color:#908CAA">;</span></span>
<span class="line"><span style="color:#908CAA">}</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">export</span><span style="color:#31748F"> function</span><span style="color:#EBBCBA"> usePersistentForm</span><span style="color:#908CAA">&#x3C;</span></span>
<span class="line"><span style="color:#9CCFD8">  TFieldValues</span><span style="color:#31748F"> extends</span><span style="color:#9CCFD8"> FieldValues</span><span style="color:#31748F"> =</span><span style="color:#9CCFD8"> FieldValues</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#9CCFD8">  TContext</span><span style="color:#31748F"> =</span><span style="color:#9CCFD8"> any</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#9CCFD8">  TTransformedValues</span><span style="color:#31748F"> extends</span><span style="color:#9CCFD8"> FieldValues</span><span style="color:#31748F"> |</span><span style="color:#9CCFD8"> undefined</span><span style="color:#31748F"> =</span><span style="color:#9CCFD8"> undefined</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#908CAA">>({</span></span>
<span class="line"><span style="color:#C4A7E7;font-style:italic">  storage</span><span style="color:#31748F"> =</span><span style="color:#31748F"> typeof</span><span style="color:#E0DEF4;font-style:italic"> window</span><span style="color:#31748F"> !=</span><span style="color:#F6C177"> "undefined"</span><span style="color:#31748F"> ?</span><span style="color:#E0DEF4;font-style:italic"> sessionStorage</span><span style="color:#31748F"> :</span><span style="color:#EBBCBA"> undefined</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#C4A7E7;font-style:italic">  storageKey</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#C4A7E7;font-style:italic">  skipStorageValidation</span><span style="color:#31748F"> =</span><span style="color:#EBBCBA"> false</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#EBBCBA;font-style:italic">  defaultValues</span><span style="color:#908CAA">:</span><span style="color:#C4A7E7;font-style:italic"> initValues</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#31748F">  ...</span><span style="color:#C4A7E7;font-style:italic">props</span></span>
<span class="line"><span style="color:#908CAA">}</span><span style="color:#31748F">:</span><span style="color:#9CCFD8"> UsePersistentFormProps</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">TFieldValues</span><span style="color:#908CAA">,</span><span style="color:#9CCFD8"> TContext</span><span style="color:#908CAA">>)</span><span style="color:#31748F">:</span><span style="color:#9CCFD8"> UsePersistentFormReturn</span><span style="color:#908CAA">&#x3C;</span></span>
<span class="line"><span style="color:#9CCFD8">  TFieldValues</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#9CCFD8">  TContext</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#9CCFD8">  TTransformedValues</span></span>
<span class="line"><span style="color:#908CAA">></span><span style="color:#908CAA"> {</span></span>
<span class="line"><span style="color:#31748F">  if</span><span style="color:#E0DEF4"> (</span><span style="color:#31748F">!</span><span style="color:#E0DEF4;font-style:italic">storage</span><span style="color:#E0DEF4">)</span></span>
<span class="line"><span style="color:#31748F">    throw</span><span style="color:#31748F"> new</span><span style="color:#EBBCBA"> Error</span><span style="color:#E0DEF4">(</span></span>
<span class="line"><span style="color:#F6C177">      "usePersistentForm was called on the server. Server doesn't have any access to the storage object."</span></span>
<span class="line"><span style="color:#E0DEF4">    )</span><span style="color:#908CAA">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">  const</span><span style="color:#E0DEF4;font-style:italic"> key</span><span style="color:#31748F"> =</span><span style="color:#EBBCBA"> storageKeyToString</span><span style="color:#E0DEF4">(</span><span style="color:#E0DEF4;font-style:italic">storageKey</span><span style="color:#E0DEF4">)</span><span style="color:#908CAA">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">  const</span><span style="color:#E0DEF4;font-style:italic"> defaultValues</span><span style="color:#31748F"> =</span><span style="color:#EBBCBA"> getFormDefaultValues</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">TFieldValues</span><span style="color:#908CAA">></span><span style="color:#E0DEF4">(</span></span>
<span class="line"><span style="color:#E0DEF4;font-style:italic">    key</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#E0DEF4;font-style:italic">    storage</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#E0DEF4;font-style:italic">    initValues</span></span>
<span class="line"><span style="color:#E0DEF4">  )</span><span style="color:#908CAA">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">  const</span><span style="color:#E0DEF4;font-style:italic"> form</span><span style="color:#31748F"> =</span><span style="color:#EBBCBA"> useForm</span><span style="color:#908CAA">&#x3C;</span><span style="color:#9CCFD8">TFieldValues</span><span style="color:#908CAA">,</span><span style="color:#9CCFD8"> TContext</span><span style="color:#908CAA">,</span><span style="color:#9CCFD8"> TTransformedValues</span><span style="color:#908CAA">></span><span style="color:#E0DEF4">(</span><span style="color:#908CAA">{</span></span>
<span class="line"><span style="color:#31748F">    ...</span><span style="color:#E0DEF4;font-style:italic">props</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#E0DEF4;font-style:italic">    defaultValues</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#908CAA">  }</span><span style="color:#E0DEF4">)</span><span style="color:#908CAA">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">  const</span><span style="color:#E0DEF4;font-style:italic"> watchedValues</span><span style="color:#31748F"> =</span><span style="color:#EBBCBA"> useWatch</span><span style="color:#E0DEF4">(</span><span style="color:#908CAA">{</span></span>
<span class="line"><span style="color:#E0DEF4">    control</span><span style="color:#908CAA">:</span><span style="color:#E0DEF4;font-style:italic"> form</span><span style="color:#31748F">.</span><span style="color:#E0DEF4;font-style:italic">control</span><span style="color:#908CAA">,</span></span>
<span class="line"><span style="color:#908CAA">  }</span><span style="color:#E0DEF4">)</span><span style="color:#908CAA">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#EBBCBA">  useEffect</span><span style="color:#E0DEF4">(</span><span style="color:#908CAA">()</span><span style="color:#31748F"> =></span><span style="color:#908CAA"> {</span></span>
<span class="line"><span style="color:#E0DEF4;font-style:italic">    storage</span><span style="color:#31748F">.</span><span style="color:#EBBCBA">setItem</span><span style="color:#E0DEF4">(</span><span style="color:#E0DEF4;font-style:italic">key</span><span style="color:#908CAA">,</span><span style="color:#E0DEF4;font-style:italic"> JSON</span><span style="color:#31748F">.</span><span style="color:#EBBCBA">stringify</span><span style="color:#E0DEF4">(</span><span style="color:#E0DEF4;font-style:italic">watchedValues</span><span style="color:#E0DEF4">))</span><span style="color:#908CAA">;</span></span>
<span class="line"><span style="color:#908CAA">  },</span><span style="color:#E0DEF4"> [</span><span style="color:#E0DEF4;font-style:italic">watchedValues</span><span style="color:#E0DEF4">])</span><span style="color:#908CAA">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">  const</span><span style="color:#E0DEF4;font-style:italic"> clearData</span><span style="color:#31748F"> =</span><span style="color:#EBBCBA"> useCallback</span><span style="color:#E0DEF4">(</span><span style="color:#908CAA">()</span><span style="color:#31748F"> =></span><span style="color:#908CAA"> {</span></span>
<span class="line"><span style="color:#E0DEF4;font-style:italic">    storage</span><span style="color:#31748F">.</span><span style="color:#EBBCBA">removeItem</span><span style="color:#E0DEF4">(</span><span style="color:#E0DEF4;font-style:italic">key</span><span style="color:#E0DEF4">)</span><span style="color:#908CAA">;</span></span>
<span class="line"><span style="color:#908CAA">  },</span><span style="color:#E0DEF4"> [</span><span style="color:#E0DEF4;font-style:italic">key</span><span style="color:#908CAA">,</span><span style="color:#E0DEF4;font-style:italic"> storage</span><span style="color:#E0DEF4">])</span><span style="color:#908CAA">;</span></span>
<span class="line"></span>
<span class="line"><span style="color:#31748F">  return</span><span style="color:#908CAA"> {</span><span style="color:#31748F"> ...</span><span style="color:#E0DEF4;font-style:italic">form</span><span style="color:#908CAA">,</span><span style="color:#E0DEF4;font-style:italic"> clearData</span><span style="color:#908CAA"> };</span></span>
<span class="line"><span style="color:#908CAA">}</span></span>
<span class="line"></span></code></pre>